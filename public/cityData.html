<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Data Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/x-icon" href="img/default.png">
</head>
<body>
    <h1>City Data Management</h1>
    <center>
        <i class="fas fa-city"></i>
    </center>
    <div id="app">
        <table id="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>City</th>
                    <th>Places to Visit</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be dynamically added here -->
            </tbody>
        </table>
    </div>

    <div id="newRecordForm" style="display: none;">
        <div class="popup-content">
            <span class="close-popup" onclick="closeNewRecordForm()">&times;</span>
            <h2>Add New Record</h2>
            <form id="addForm">
                <label for="newCity">City:</label>
                <input type="text" id="newCity" placeholder="Enter City" required>
                <label for="newPlaces">Places to Visit:</label>
                <input type="text" id="newPlaces" placeholder="Enter Places to Visit" required>
                <button type="submit">Add</button>
            </form>
        </div>
    </div>
    

    <div id="editPopup" class="popup" style="display: none;">
        <div class="popup-content">
            <span class="close-popup" onclick="closePopup()">&times;</span>
            <h2>Edit Value</h2>
            <form id="editForm">
                <label for="editValue">New Value:</label>
                <input type="text" id="editValue" required>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <center>
    <button onclick="openNewRecordForm()">Add New Record</button>
    </center>

    <h4>Click on <b>"Add New Record"</b> button to add a New City with Places to Visit. <b>Right click</b> on the City or Places to Visit if you need to edit them.<br />For <b>add many places</b> to a one city use commas to seperate them. (Ex:- Star Fort, Mirissa Whale Watching)<br /><br />This will make us easy to select the Accommodations from the Data.</h4>
    <br>
    <center>
        <img src="example/cityData.png" height="300px" width="450px" />
    </center>

    <script>
        async function addRecord(city, places) {
            try {
                const response = await fetch('/api/cityData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ city, places })
                });
                const data = await response.json();
                if (data.message === 'Data saved successfully') {
                    closeNewRecordForm();
                    renderData();
                }
            } catch (error) {
                console.error('Error adding record:', error);
            }
        }

        function openNewRecordForm() {
            const form = document.getElementById('newRecordForm');
            form.style.display = 'block';
        }

        function closeNewRecordForm() {
            const form = document.getElementById('newRecordForm');
            form.style.display = 'none';
        }

        document.getElementById('newRecordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const city = document.getElementById('newCity').value;
            const places = document.getElementById('newPlaces').value;
            addRecord(city, places);
            document.getElementById('newCity').value = '';
            document.getElementById('newPlaces').value = '';
           
        });

        async function fetchData() {
            try {
                const response = await fetch('/api/cityData');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        async function renderData() {
    try {
        const data = await fetchData();
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = ''; // Clear previous content

        data.forEach(item => {
            const row = document.createElement('tr');
            row.setAttribute('data-id', item.id); // Set the data-id attribute to the record ID
            Object.keys(item).forEach((key, index) => {
                const cell = document.createElement('td');
                cell.textContent = item[key];
                // Exclude the first column (ID column) from being editable
                if (index !== 0) {
                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault(); // Prevent the default context menu
                        openPopup(item.id, key, cell.textContent); // Open the edit popup
                    });
                }
                row.appendChild(cell);
            });
            // Add delete action with icon on actions
            const deleteCell = document.createElement('td');
            const deleteIcon = document.createElement('i');
            deleteIcon.classList.add('fas', 'fa-trash-alt');
            deleteIcon.addEventListener('click', () => {
                deleteRecord(item.id);
            });
            deleteCell.appendChild(deleteIcon);
            row.appendChild(deleteCell);
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error rendering data:', error);
    }
}


        document.addEventListener('DOMContentLoaded', () => {
            renderData();
        });

        function openPopup(id, column, value) {
            const popup = document.getElementById('editPopup');
            const editValueInput = document.getElementById('editValue');
            editValueInput.value = value;
            popup.style.display = 'block';
            // Add event listener to save button
            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newValue = editValueInput.value;
                const updatedData = await updateRecord(id, column, newValue);
                if (updatedData) {
                    closePopup();
                    renderData();
                }
            });
        }

        function closePopup() {
            const popup = document.getElementById('editPopup');
            popup.style.display = 'none';
        }

        async function updateRecord(id, column, newValue) {
    try {
        // Fetch the existing record data from the UI
        const row = document.querySelector(`#data-table tbody tr[data-id="${id}"]`);
        if (!row) {
            console.error('Error updating record: Row not found');
            return null;
        }

        // Existing record found, proceed with updating
        const existingRecord = {
            id: row.dataset.id,
            city: row.cells[1].textContent,
            places: row.cells[2].textContent,
        };

        // Merge the updated field with the existing record data
        const updatedRecord = { ...existingRecord, [column]: newValue };

        const response = await fetch(`/api/cityData/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedRecord) // Send the entire updated record data
        });

        const updatedData = await response.json();
        return updatedData;
    } catch (error) {
        console.error('Error updating record:', error);
        return null;
    }
}


        async function deleteRecord(id) {
            try {
                const response = await fetch(`/api/cityData/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    renderData();
                } else {
                    console.error('Failed to delete record');
                }
            } catch (error) {
                console.error('Error deleting record:', error);
            }
        }
    </script>
</body>
</html>
